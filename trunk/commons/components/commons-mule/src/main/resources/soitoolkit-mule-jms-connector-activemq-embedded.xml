<?xml version="1.0" encoding="UTF-8"?>
<mule 
	xmlns="http://www.mulesource.org/schema/mule/core/2.2"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
    xmlns:spring="http://www.springframework.org/schema/beans"
	xmlns:jms="http://www.mulesource.org/schema/mule/jms/2.2"
	xmlns:amq="http://activemq.apache.org/schema/core"
	xsi:schemaLocation="
		http://www.springframework.org/schema/beans    http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
		http://www.mulesource.org/schema/mule/core/2.2 http://www.mulesource.org/schema/mule/core/2.2/mule.xsd 
		http://www.mulesource.org/schema/mule/jms/2.2  http://www.mulesource.org/schema/mule/jms/2.2/mule-jms.xsd
		http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd"> 

    <spring:beans>
        <spring:import resource="classpath:soitoolkit-mule-jms-connector-commons.xml"/>

		<amq:broker id="broker" brokerName="localhost" persistent="true" useJmx="false" start="true" >
			<amq:destinationPolicy>
				<amq:policyMap>
					<amq:policyEntries>
		                <amq:policyEntry queue=">" producerFlowControl="true" memoryLimit="1mb">
							<amq:deadLetterStrategy>
								<!-- Use the prefix 'DLQ.' for the destination name, and make the DLQ a 
									queue rather than a topic -->
								<amq:individualDeadLetterStrategy
									queuePrefix="DLQ." useQueueForQueueMessages="true" />
							</amq:deadLetterStrategy>
						</amq:policyEntry>
					</amq:policyEntries>
				</amq:policyMap>
			</amq:destinationPolicy>
			<amq:transportConnectors>
	            <amq:transportConnector name="openwire" uri="tcp://0.0.0.0:61616"/>
				<amq:transportConnector uri="vm://localhost" />
			</amq:transportConnectors>
		</amq:broker>
    </spring:beans>

	<spring:bean name="soitoolkit-jms-connection-factory"
		class="org.apache.activemq.ActiveMQConnectionFactory" depends-on="broker">
		<spring:property name="brokerURL" value="vm://localhost" />
		<spring:property name="redeliveryPolicy">
			<spring:bean class="org.apache.activemq.RedeliveryPolicy">
				<spring:property name="maximumRedeliveries" value="0" />
			</spring:bean>
		</spring:property>
	</spring:bean>

	<jms:connector name="soitoolkit-jms-connector"
		connectionFactory-ref="soitoolkit-jms-connection-factory"
		disableTemporaryReplyToDestinations="true" 
		persistentDelivery="true"
		numberOfConsumers="2"
		specification="1.1"
		maxRedelivery="-1">
		
		<custom-exception-strategy class="org.soitoolkit.commons.mule.error.ExceptionHandler"/>
	</jms:connector>
		
</mule>